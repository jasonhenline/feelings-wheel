<head>
    <title>Feelings Wheel</title>
    <style>
    #container {
        position: relative;
    }

    #pointerImg {
        position: absolute;
        top: 100px;
        left: 363px;
        z-index: 1;
        transform-origin: bottom center;
    }

    #button {
        user-select: none;
    }
</style>
</head>
<body>
    <div id="container">
        <div>
            <img
                src="wheel-of-feelings.png"
                width="750"
            >
            <img
                id="pointerImg"
                src="pointer.png"
                height="180"
            >
        </div>
        <div>
            <button id="button">Click and Hold to Build Power</button>
            <progress
                id="progress"
                max="1"
                value="0"
            ></progress>
        </div>
    </div>

    <script>
        const style = pointerImg.style;
        let currentDegrees = 0;

        const setRotationDegrees = degrees => style.transform = `rotate(${degrees}deg)`;

        const getCurrentMilliseconds = () => (new Date()).valueOf();

        button.addEventListener('pointerdown', () => {
            let progressBuildingStartTimestamp;
            let isBuildingProgress = true;
            let progressValue = 0;

            const drawSpinner = () => {
                setRotationDegrees(currentDegrees);
                requestAnimationFrame(drawSpinner);
            }
            requestAnimationFrame(drawSpinner);

            const stepProgressBuilding = timestamp => {
                if (!isBuildingProgress) {
                    progressValue = 0;
                    progress.value = 0;
                    return;
                }
                if (progressBuildingStartTimestamp === undefined) {
                    progressBuildingStartTimestamp = timestamp;
                }
                const dt = timestamp - progressBuildingStartTimestamp;
                progressValue = Math.tanh(5e-4 * dt) * (1 - 5e-2 * Math.random());
                progress.value = progressValue;
                requestAnimationFrame(stepProgressBuilding);
            }

            const handleButtonMouseUp = () => {
                button.removeEventListener('pointerup', handleButtonMouseUp);
                isBuildingProgress = false;

                const a = 3e-4;
                let v = 2 * progressValue;

                let lastSpinTimestamp = getCurrentMilliseconds();
                const stepSpinner = () => {
                    const currentTimestamp = getCurrentMilliseconds();
                    const dt = currentTimestamp - lastSpinTimestamp;
                    lastSpinTimestamp = currentTimestamp;
                    v = v - a * dt;

                    if (v > 0) {
                        currentDegrees += v * dt;
                        setTimeout(stepSpinner, 1);
                    }
                }

                stepSpinner();
            }

            button.addEventListener('pointerup', handleButtonMouseUp);

            const handleWindowMouseUp = () => {
                button.removeEventListener('pointerup', handleButtonMouseUp);
                window.removeEventListener('pointerup', handleWindowMouseUp);
                isBuildingProgress = false;
            }

            window.addEventListener('pointerup', handleWindowMouseUp);

            requestAnimationFrame(stepProgressBuilding);
        });

        setRotationDegrees(currentDegrees);
    </script>
</body>
