<head>
    <title>Feelings Wheel</title>
    <style>
    #container {
        position: relative;
    }

    #pointerImg {
        position: absolute;
        top: 100px;
        left: 363px;
        z-index: 1;
        transform-origin: bottom center;
    }

    #button {
        user-select: none;
        font-size: 24px;
        width: 200px;
    }

    .flex {
        display: flex;
        align-items: center;
    }

    .flex * + * {
        margin-left: 30px;
    }

    progress {
        height: 80px;
        width: 510px;
    }
</style>
</head>
<body>
    <div id="container">
        <div>
            <img
                src="wheel-of-feelings.png"
                width="750"
            >
            <img
                id="pointerImg"
                src="pointer.png"
                height="180"
            >
        </div>
        <div class="flex">
            <button id="button">Click and Hold to Build Power</button>
            <progress
                id="progress"
                max="1"
                value="0"
            ></progress>
        </div>
    </div>

    <script>
        let currentDegrees = 0;

        const setRotationDegrees = degrees => pointerImg.style.transform = `rotate(${degrees}deg)`;

        const getCurrentMilliseconds = () => (new Date()).valueOf();

        button.addEventListener('pointerdown', () => {
            let progressBuildingStartTimestamp;
            let isBuildingProgress = true;
            let progressValue = 0;

            const stepProgressBuilding = timestamp => {
                if (!isBuildingProgress) {
                    progressValue = 0;
                    progress.value = 0;
                    return;
                }
                if (progressBuildingStartTimestamp === undefined) {
                    progressBuildingStartTimestamp = timestamp;
                }
                const dt = timestamp - progressBuildingStartTimestamp;
                progressValue = Math.tanh(5e-4 * dt) * (1 - 5e-2 * Math.random());
                progress.value = progressValue;
                requestAnimationFrame(stepProgressBuilding);
            }

            const handleButtonMouseUp = () => {
                button.removeEventListener('pointerup', handleButtonMouseUp);
                isBuildingProgress = false;

                const t0 = getCurrentMilliseconds();
                const x0 = currentDegrees;
                const v0 = 2 * progressValue;
                const a = 3e-4;

                const stepSpinner = () => {
                    const t = getCurrentMilliseconds();
                    const dt = t - t0;
                    const v = v0 - a * dt;

                    if (v > 0) {
                        currentDegrees = x0 + 0.5 * (v + v0) * dt;
                        requestAnimationFrame(stepSpinner);
                    } else {
                        currentDegrees = x0 + 0.5 * v0 * v0 / a;
                    }

                    setRotationDegrees(currentDegrees);
                }

                stepSpinner();
            }

            button.addEventListener('pointerup', handleButtonMouseUp);

            const handleWindowMouseUp = () => {
                button.removeEventListener('pointerup', handleButtonMouseUp);
                window.removeEventListener('pointerup', handleWindowMouseUp);
                isBuildingProgress = false;
            }

            window.addEventListener('pointerup', handleWindowMouseUp);

            requestAnimationFrame(stepProgressBuilding);
        });

        setRotationDegrees(currentDegrees);
    </script>
</body>
