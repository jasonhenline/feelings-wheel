<head>
    <title>Feelings Wheel</title>
    <style>
    #container {
        position: relative;
    }

    #pointerImg {
        position: absolute;
        top: 100px;
        left: 363px;
        z-index: 1;
        transform-origin: bottom center;
    }
</style>
</head>
<body>
    <div id="container">
        <div>
            <img
                src="wheel-of-feelings.png"
                width="750"
            >
            <img
                id="pointerImg"
                src="pointer.png"
                height="180"
            >
        </div>
        <div>
            <button id="button">Click and Hold to Build Power</button>
            <progress
                id="progress"
                max="1"
                value="0"
            ></progress>
        </div>
    </div>

    <script>
        const style = pointerImg.style;
        let currentDegrees = 0;

        const setRotationDegrees = degrees => style.transform = `rotate(${degrees}deg)`;

        button.addEventListener('mousedown', () => {
            let progressBuildingStartTimestamp;
            let isBuildingProgress = true;
            let progressValue = 0;

            const stepProgressBuilding = timestamp => {
                if (!isBuildingProgress) {
                    progressValue = 0;
                    progress.value = 0;
                    return;
                }
                if (progressBuildingStartTimestamp === undefined) {
                    progressBuildingStartTimestamp = timestamp;
                }
                const dt = timestamp - progressBuildingStartTimestamp;
                progressValue = Math.tanh(5e-4 * dt) * (1 - 1e-2 * Math.random());
                progress.value = progressValue;
                requestAnimationFrame(stepProgressBuilding);
            }

            const handleButtonMouseUp = () => {
                button.removeEventListener('mouseup', handleButtonMouseUp);
                isBuildingProgress = false;

                const a = 5e-9;
                let v = 1e-2 * progressValue;

                let lastSpinTimestamp;
                const stepSpinner = timestamp => {
                    if (lastSpinTimestamp === undefined) {
                        lastSpinTimestamp = timestamp;
                    }
                    const dt = timestamp - lastSpinTimestamp;
                    v = v - a * dt;

                    if (v > 0) {
                        currentDegrees += v * dt;
                        requestAnimationFrame(stepSpinner);
                    }

                    setRotationDegrees(currentDegrees)
                }
                requestAnimationFrame(stepSpinner);
            }

            button.addEventListener('mouseup', handleButtonMouseUp);

            const handleWindowMouseUp = () => {
                button.removeEventListener('mouseup', handleButtonMouseUp);
                window.removeEventListener('mouseup', handleWindowMouseUp);
                isBuildingProgress = false;
            }

            window.addEventListener('mouseup', handleWindowMouseUp);

            requestAnimationFrame(stepProgressBuilding);
        });

        setRotationDegrees(currentDegrees);
    </script>
</body>
